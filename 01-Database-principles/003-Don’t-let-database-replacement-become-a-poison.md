2.1.1.3    不要让数据块平替成为一剂毒药
数据库信创替换已经是很多企业必须面对或者正在面对的问题，而且对于很多企业来说已经不仅是找几套不太重要的小系统替换一下试试的问题了。对于核心系统替代来说还问题不大，企业可以投入大量的资金、人力和时间来认真做这件事。反而是大量大型的，关键系统的替代不那么容易。因为这些系统的替代一方面还是存在一定难度，另外一方面这些系统如果出问题，还是会对企业的业务有所影响的，而更讨厌的是，这样的系统数量很多，如果都按照核心系统那么投资来干，地主家也干不起。
不知道是不是因为这个原因，想干信创替代的企业领导十分喜欢听到数据库厂商提出“平替”这个概念，数据库厂商也投其所好，说自己的产品能够“平替”Oracle。久而久之很多企业的不太懂数据库的管理者们就认为数据库平替不是一件很难的事情了。我甚至遇到过一个企业的领导提出用RDS MYSQL “平替” Oracle，他认为Oracle和MySQL的SQL都基本上符合SQL 1999的标准，没理由RDS替不了Oracle。
互联网企业一直兜售把业务回归应用来释放数据库，从而将对系统对数据库的要求。实际上极少数传统企业的IT部门能够真正的学会互联网企业的研发技巧，实际上里面暗藏的一些东西互联网企业们并没有向客户说清楚，那就是这个逻辑背后是对研发的数倍成本的投入，以及企业被软件开发商的深度绑定。我曾经遇到过一个企业，他们顺应甲方领导的思路，把应用系统从Oracle迁移到阿里云RDS MYSQL上，用了几十个RDS数据库替换以前的一个Oracle数据库，为此他们针对这套系统专门开发了一个分库分表的数据库路由中间层。我和他们交流的时候问他们为什么要费时费力做这些事情，弄得不好这个项目可能会做亏了。他看着我笑了笑说：“现在吃点苦是值得的，通过这个项目，我们的研发能力提高了一大截。从另外一个角度来看，我敢说这个系统上线的时候，就是甲方离不开我们的时候了，钱不一定都赚在一时”。我想这个哥们从自己企业的角度来考虑这件事，肯定是没错的，但是如果甲方的领导听到这句话会不会脖子后面冒凉风啊。
事实上企业在做大量的数据库“平替”的时候，并没有给应用改造和系统迁移留下多少经费，因此“平替”工作仅仅从应用兼容性来考虑就可以了，对于大多数系统来说平替后虽然慢了一些，但是还可以忍受。实在忍受不了的，再做些优化就可以了。大不了把这些问题遗留给运维，让运维慢慢去解决好了。
不过对于核心系统或者次核心系统来说就没那么简单了，企业的决策者不能只是用“平替”这两个字来对待了。如果不能在数据库迁移替换时做足功课，那么将会是后患无穷的。比如说我们要把一个系统种的Oracle数据库替换成基于PG的国产数据库。如果国产数据库做了一些Oracle数据库语法兼容的工作，那么数据库迁移替换工作会十分顺利。甚至有些国产数据库连PL/SQL的兼容性都很好，那样情况下，迁移就更顺利了。不过迁移完成后，大量的性能问题就冒出来了。
实际上做数据库迁移的时候不仅仅要考虑兼容性，还要考虑二者之间的一些技术差异，要想办法弥补国产数据库的缺陷。比如对于PG数据库来说，一些WHERE 条件带or的SQL，如果以前Oracle上的执行计划使用HASH JOIN效果很好，到了PG或者PG兼容的国产数据库上，就只能走NESTED LOOP了。如果JOIN的表数据量很大，返回的结果集也很大，那么迁移时就必须对SQL进行改写，否则迁移后的性能必然是无法接受的。
除此之外，我们还需要充分利用开源或者国产数据库的优势能力。还是以Oracle向PG或PG兼容的国产数据库迁移。PG数据库的索引种类比Oracle要丰富的多，如果选用得当，那将会事半功倍。这时候如果应用开发人员能够配合DBA进行索引的优化设计，将会让迁移工作更加顺利。另外如果我们的某些数据的写入和访问时带有时序特性的，那么迁移到PG的时候直接用timescaledb的表来存放，设计好自动分区的策略和老数据压缩的策略，那么这部分的数据访问效率也会大大的提高。
在数据库迁移替代工作中，能够“平替”肯定会大大节约迁移的成本，但是我们不能因为“平替”能力的存在而放弃优化工作，否则就会为今后的长期应用与运维买下一株邪恶的毒草。



## Don’t let database replacement become a poison

Database replacement is already a problem that many enterprises have to face or are facing, and for many enterprises it is no longer just a matter of trying a few less important small systems. For core system replacement, there is still no big problem, enterprises can invest a lot of money, manpower and time to do this seriously. On the contrary, it is not so easy to replace a large number of large-scale, key systems. Because the replacement of these systems is still difficult on the one hand, and on the other hand, if these systems have problems, they will still have an impact on the business of the enterprise, and what is more annoying is that there are many such systems, if they are all invested according to the core system, the landlord’s family can not afford it.

I don’t know if it’s because of this reason, but the enterprise leaders who want to do domestic database replacement like to hear the database manufacturers put forward the concept of “replacement (replace as much as possible without modifying the application)”, and the database manufacturers also cater to their preferences, saying that their products can “replace” Oracle. Over time, many enterprise managers who don’t know much about databases think that database replacement is not a difficult thing. I even met a leader of an enterprise who proposed to use RDS MYSQL to “replace” Oracle, he thought that Oracle and MySQL’s SQL are basically in line with the SQL 1999 standard, there is no reason why RDS can not replace Oracle.

 Internet enterprises have been selling the idea of returning business to applications to release databases, thereby reducing the system’s requirements for databases. In fact, very few traditional enterprise IT departments can really learn the development skills of Internet enterprises, and there are some hidden things behind this logic that Internet enterprises have not made clear to customers, that is, this logic is behind the investment of several times the cost of development, and the enterprise is deeply bound by software developers. I once encountered an enterprise, they followed the idea of Party A’s leader, moved the application system from Oracle to Alibaba Cloud RDS MYSQL, used dozens of RDS databases to replace the previous Oracle database, and developed a database routing middleware for this system. When I communicated with them, I asked them why they spent so much time and effort doing these things, and it might not be good for the project to lose money. He looked at me and smiled and said: “It’s worth it to suffer a bit now, through this project, our development capabilities have improved a lot. From another perspective, I dare say that when this system goes online, it’s when Party A can’t do without us, and money doesn’t necessarily have to be made in a moment.” I think this guy is right to consider this from his own enterprise’s perspective, but if  leader of customer hears this, will he feel a chill behind his neck? 

In fact, when enterprises do a lot of database “replacement”, they do not leave much money for application transformation and system migration, so the “replacement” work can be considered only from the application compatibility, for most systems, although the replacement is slower, but it can still be tolerated. If it can’t be tolerated, then do some optimization. At worst, leave these problems to the operation and maintenance, and let them solve them slowly. But for core systems or sub-core systems, it’s not that simple, and enterprise decision-makers can’t just use the word “replacement” to deal with it. If you don’t do enough homework when migrating and replacing databases, it will be endless trouble.

For example, if we want to replace an Oracle database in a system with a domestic database based on PostgreSQL(PG). If the domestic database has done some Oracle database syntax compatibility work, then the database migration and replacement work will be very smooth. Some domestic databases even have good PL/SQL compatibility, in that case, the migration will be smoother. But after the migration is completed, a lot of performance problems will come out. In fact, when doing database migration, we need to consider not only compatibility, but also some technical differences between the two, and try to make up for the shortcomings of domestic databases. For example, for PG databases, some WHERE conditions with or SQL, if the execution plan on Oracle used HASH JOIN effect is very good, to PG or PG compatible domestic database, can only go NESTED LOOP. If the JOIN table data volume is large, the return result set is also large, then the migration must rewrite SQL, otherwise the performance after migration will be unacceptable. In addition, we also need to make full use of the advantages of open source or domestic databases. 

Still with Oracle to PG or PG compatible domestic database migration. PG database index types are much richer than Oracle, if chosen properly, it will be twice the result with half the effort. If the application developers can cooperate with DBA to optimize the design of the index, it will make the migration work more smoothly. In addition, if some of our data writing and access are time-sequential, then migrate to PG directly using timescaledb table to store, design a good automatic partitioning strategy and old data compression strategy, then this part of the data access efficiency will also be greatly improved. In the database migration and replacement work, being able to “replace” will definitely save a lot of migration costs, but we can not give up the optimization work because of the existence of the “replacement” ability, otherwise it will buy a evil poison for the long-term application and operation and maintenance.




